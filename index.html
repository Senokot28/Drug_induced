<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Antidote & Adverse Events Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* ================== CSS ‡∏™‡πÑ‡∏ï‡∏•‡πå ================== */
        body { font-family: 'Sarabun', sans-serif; padding: 15px; background-color: #f4f7f6; margin: 0; color: #333; }
        .header-title { text-align: center; color: #b71c1c; margin-bottom: 20px; font-size: 1.8em; font-weight: bold; }
        
        /* ‡πÅ‡∏ñ‡∏ö Slicer */
        .slicer-container { display: flex; flex-wrap: wrap; gap: 15px; justify-content: center; background: white; padding: 15px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .slicer-box { display: flex; flex-direction: column; min-width: 220px; flex: 1; max-width: 300px; }
        .slicer-box label { font-size: 0.9em; font-weight: bold; color: #b71c1c; margin-bottom: 5px; }
        .slicer-box select { padding: 10px; border-radius: 5px; border: 1px solid #ccc; font-size: 1em; outline: none; font-family: 'Sarabun', sans-serif; cursor: pointer; }

        /* ‡∏Å‡∏•‡πà‡∏≠‡∏á KPI ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç */
        .kpi-container { display: flex; flex-wrap: wrap; gap: 15px; margin-bottom: 20px; }
        .kpi-card { flex: 1; min-width: 150px; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); text-align: center; border-bottom: 4px solid #e0e0e0; }
        .kpi-card.kpi-cases { border-color: #1976d2; }
        .kpi-card.kpi-qty { border-color: #d32f2f; }
        .kpi-card.kpi-opd { border-color: #388e3c; }
        .kpi-card.kpi-ipd { border-color: #f57c00; }
        .kpi-title { font-size: 0.95em; color: #666; margin-bottom: 10px; font-weight: bold; }
        .kpi-value { font-size: 2.2em; font-weight: bold; }
        .val-cases { color: #1976d2; } .val-qty { color: #d32f2f; } .val-opd { color: #388e3c; } .val-ipd { color: #f57c00; }

        /* ‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡∏£‡∏≤‡∏ü 2x2 Grid (‡∏ö‡∏ô 2 ‡∏•‡πà‡∏≤‡∏á 2) */
        .charts-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-bottom: 30px; }
        .chart-card { background: white; padding: 15px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .chart-title { text-align: center; color: #333; font-size: 1.1em; margin-bottom: 15px; font-weight: bold; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .canvas-wrapper { position: relative; width: 100%; height: 320px; } /* ‡∏õ‡∏£‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á‡∏Å‡∏£‡∏≤‡∏ü‡πÉ‡∏´‡πâ‡∏™‡∏°‡∏î‡∏∏‡∏• */

        /* ‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á */
        .table-card { background: white; padding: 15px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); margin-bottom: 30px; }
        .table-wrapper { max-height: 400px; overflow: auto; border: 1px solid #eee; border-radius: 5px; -webkit-overflow-scrolling: touch; }
        table { width: 100%; border-collapse: collapse; font-size: 0.85em; min-width: 800px; }
        th, td { padding: 10px 8px; text-align: right; border-bottom: 1px solid #eee; }
        th:nth-child(1), td:nth-child(1) { text-align: center; width: 40px; }
        th:nth-child(2), td:nth-child(2), th:nth-child(3), td:nth-child(3) { text-align: left; } 
        th { position: sticky; top: 0; background-color: #ffebee; color: #b71c1c; z-index: 1; font-weight: bold; white-space: nowrap; }
        tbody tr:hover { background-color: #f5f5f5; }

        /* Footer */
        .footer-link { text-align: center; margin-top: 20px; margin-bottom: 40px; font-size: 0.9em; color: #666; }
        .footer-link a { color: #b71c1c; text-decoration: none; font-weight: bold; background-color: white; padding: 8px 15px; border-radius: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); display: inline-block; margin-top: 10px; transition: 0.3s;}
        .footer-link a:hover { background-color: #b71c1c; color: white; }
        
        /* ‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ */
        @media (max-width: 800px) {
            .charts-grid { grid-template-columns: 1fr; } /* ‡∏ö‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠‡∏à‡∏∞‡πÄ‡∏£‡∏µ‡∏¢‡∏á 1 ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏•‡∏á‡∏°‡∏≤ */
        }
    </style>
</head>
<body>

    <div style="max-width: 1300px; margin: auto;">
        <div class="header-title">üö® Dashboard ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏¢‡∏≤‡∏ï‡πâ‡∏≤‡∏ô‡∏û‡∏¥‡∏©‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡πÅ‡∏û‡πâ‡∏¢‡∏≤</div>

        <div class="slicer-container">
            <div class="slicer-box">
                <label for="yearFilter">üìÖ ‡∏õ‡∏µ‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì:</label>
                <select id="yearFilter" onchange="updateDashboard()">
                    <option value="all">‡∏£‡∏ß‡∏°‡∏ó‡∏∏‡∏Å‡∏õ‡∏µ (66-69)</option>
                    <option value="66">‡∏õ‡∏µ 2566</option>
                    <option value="67">‡∏õ‡∏µ 2567</option>
                    <option value="68">‡∏õ‡∏µ 2568</option>
                    <option value="69">‡∏õ‡∏µ 2569 (4‡πÄ‡∏î‡∏∑‡∏≠‡∏ô)</option>
                </select>
            </div>
            <div class="slicer-box">
                <label for="drugFilter">üíä ‡∏ä‡∏∑‡πà‡∏≠‡∏¢‡∏≤ (Drug Name):</label>
                <select id="drugFilter" onchange="updateDashboard()">
                    <option value="all">‡πÅ‡∏™‡∏î‡∏á‡∏¢‡∏≤‡∏ó‡∏∏‡∏Å‡∏ä‡∏ô‡∏¥‡∏î</option>
                </select>
            </div>
            <div class="slicer-box">
                <label for="deptFilter">üè• ‡πÅ‡∏ú‡∏ô‡∏Å (Department):</label>
                <select id="deptFilter" onchange="updateDashboard()">
                    <option value="all">‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏∏‡∏Å‡πÅ‡∏ú‡∏ô‡∏Å</option>
                </select>
            </div>
        </div>

        <div class="kpi-container">
            <div class="kpi-card kpi-cases">
                <div class="kpi-title">‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (Cases)</div>
                <div class="kpi-value val-cases" id="kpiCases">0</div>
            </div>
            <div class="kpi-card kpi-qty">
                <div class="kpi-title">‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì‡∏¢‡∏≤‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ (Total QTY)</div>
                <div class="kpi-value val-qty" id="kpiQty">0</div>
            </div>
            <div class="kpi-card kpi-opd">
                <div class="kpi-title">‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏ô‡∏≠‡∏Å (OPD)</div>
                <div class="kpi-value val-opd" id="kpiOPD">0</div>
            </div>
            <div class="kpi-card kpi-ipd">
                <div class="kpi-title">‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡πÉ‡∏ô (IPD)</div>
                <div class="kpi-value val-ipd" id="kpiIPD">0</div>
            </div>
        </div>

        <div class="charts-grid">
            <div class="chart-card">
                <div class="chart-title" id="titleDrugChart">üç© ‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏¢‡∏≤ (‡∏ï‡∏≤‡∏°‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏Ñ‡∏™)</div>
                <div class="canvas-wrapper"><canvas id="drugDonutChart"></canvas></div>
            </div>
            <div class="chart-card">
                <div class="chart-title">üìä 10 ‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡πÇ‡∏£‡∏Ñ‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏¢‡∏≤‡∏°‡∏≤‡∏Å‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î</div>
                <div class="canvas-wrapper"><canvas id="diagBarChart"></canvas></div>
            </div>
            <div class="chart-card">
                <div class="chart-title">üè• 5 ‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡πÅ‡∏ú‡∏ô‡∏Å‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏Å‡∏©‡∏≤</div>
                <div class="canvas-wrapper"><canvas id="deptBarChart"></canvas></div>
            </div>
            <div class="chart-card">
                <div class="chart-title">üìà ‡πÄ‡∏ó‡∏£‡∏ô‡∏î‡πå‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏¢‡∏≤ 4 ‡∏õ‡∏µ (66-69)</div>
                <div class="canvas-wrapper"><canvas id="trendLineChart"></canvas></div>
            </div>
        </div>

        <div class="table-card">
            <div class="chart-title" style="border:none; text-align:left; color:#b71c1c;">üìã ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏¢‡∏≤</div>
            <div class="table-wrapper">
                <table id="dataTable">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Diagnosis (‡∏£‡∏´‡∏±‡∏™/‡πÇ‡∏£‡∏Ñ)</th>
                            <th>‡∏ä‡∏∑‡πà‡∏≠‡∏¢‡∏≤ (Drug Name)</th>
                            <th>‡πÅ‡∏ú‡∏ô‡∏Å‡∏´‡∏•‡∏±‡∏Å</th>
                            <th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢ (Cases)</th>
                            <th>‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì‡∏¢‡∏≤ (Total Qty)</th>
                        </tr>
                    </thead>
                    <tbody id="dataTableBody">
                        </tbody>
                </table>
            </div>
        </div>

        <div class="footer-link">
            Raw data &gt;&gt; <br>
            <a href="https://docs.google.com/spreadsheets/d/1FI9XEkbiOkr8Ml9wZ_E0eah1ycAj0mMzpPnOr_spGHg/edit?gid=1618087099#gid=1618087099" target="_blank">‡πÄ‡∏õ‡∏¥‡∏î Data link Diag (Google Sheets)</a>
        </div>
    </div>

    <script>
        // ‡πÉ‡∏ä‡πâ‡∏•‡∏¥‡∏á‡∏Å‡πå Export CSV ‡∏Ç‡∏≠‡∏á Sheet ‡πÉ‡∏´‡∏°‡πà
        const sheetUrl = "https://docs.google.com/spreadsheets/d/1FI9XEkbiOkr8Ml9wZ_E0eah1ycAj0mMzpPnOr_spGHg/export?format=csv&gid=1618087099";
        
        let rawDataGlobal = [];
        let uniqueDrugs = new Set();
        let uniqueDepts = new Set();
        let charts = { drugDonut: null, diagBar: null, deptBar: null, trendLine: null };

        Papa.parse(sheetUrl, {
            download: true,
            header: true,
            complete: function(results) {
                rawDataGlobal = results.data.filter(row => row["name_diag"] || row["drug_name"]).map(row => {
                    const diag = (row["name_diag"] || row["diag"] || row["pdx"] || "‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏").trim();
                    const tname = (row["Tname"] || row["tname"] || "").trim();
                    const drug = (row["drug_name"] || row["drug"] || "‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏¢‡∏≤").trim();
                    const dept = (row["department"] || row["‡πÅ‡∏ú‡∏ô‡∏Å"] || "‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡πÅ‡∏ú‡∏ô‡∏Å").trim();
                    const qty = parseFloat(row["qty"] || row["QTY"] || 0) || 0;
                    
                    const anValue = (row["an"] || "").trim();
                    const type = anValue === "" ? "opd" : "ipd";
                    
                    // ‡∏î‡∏∂‡∏á‡∏õ‡∏µ‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì
                    let bdgYear = (row["BDG_YEAR"] || row["vstdate"] || "").toString();
                    let year = "other";
                    if (bdgYear.includes("66") || bdgYear === "2566" || bdgYear.includes("2023")) year = "66";
                    else if (bdgYear.includes("67") || bdgYear === "2567" || bdgYear.includes("2024")) year = "67";
                    else if (bdgYear.includes("68") || bdgYear === "2568" || bdgYear.includes("2025")) year = "68";
                    else if (bdgYear.includes("69") || bdgYear === "2569" || bdgYear.includes("2026")) year = "69";

                    if(drug !== "‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏¢‡∏≤") uniqueDrugs.add(drug);
                    if(dept !== "‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡πÅ‡∏ú‡∏ô‡∏Å") uniqueDepts.add(dept);

                    return { diag, tname, drug, dept, qty, type, year };
                });

                // ‡πÄ‡∏ï‡∏¥‡∏° Dropdown ‡∏¢‡∏≤
                const drugSelect = document.getElementById("drugFilter");
                Array.from(uniqueDrugs).sort().forEach(d => {
                    let option = document.createElement("option"); option.value = d; option.text = d;
                    drugSelect.appendChild(option);
                });

                // ‡πÄ‡∏ï‡∏¥‡∏° Dropdown ‡πÅ‡∏ú‡∏ô‡∏Å
                const deptSelect = document.getElementById("deptFilter");
                Array.from(uniqueDepts).sort().forEach(d => {
                    let option = document.createElement("option"); option.value = d; option.text = d;
                    deptSelect.appendChild(option);
                });

                updateDashboard();
            }
        });

        function updateDashboard() {
            const yFilter = document.getElementById("yearFilter").value;
            const dFilter = document.getElementById("drugFilter").value;
            const depFilter = document.getElementById("deptFilter").value;

            // 1. ‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏•‡∏±‡∏Å (‡πÉ‡∏ä‡πâ‡∏ó‡∏±‡πâ‡∏á 3 Slicers ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö ‡∏ï‡∏≤‡∏£‡∏≤‡∏á ‡πÅ‡∏•‡∏∞ ‡∏Å‡∏£‡∏≤‡∏ü 3 ‡∏ï‡∏±‡∏ß‡πÅ‡∏£‡∏Å)
            const filtered = rawDataGlobal.filter(row => {
                const matchY = (yFilter === "all" || row.year === yFilter);
                const matchD = (dFilter === "all" || row.drug === dFilter);
                const matchDep = (depFilter === "all" || row.dept === depFilter);
                return matchY && matchD && matchDep;
            });

            let totalCases = 0, totalQty = 0, opdCnt = 0, ipdCnt = 0;
            const drugStats = {};
            const diagStats = {};
            const deptStats = {};
            const tableMap = {};

            filtered.forEach(row => {
                totalCases++;
                totalQty += row.qty;
                if (row.type === "opd") opdCnt++; else ipdCnt++;

                // ‡∏ô‡∏±‡∏ö‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏¢‡∏≤
                if (!drugStats[row.drug]) drugStats[row.drug] = 0;
                drugStats[row.drug]++;

                // ‡∏ô‡∏±‡∏ö‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡πÇ‡∏£‡∏Ñ
                const fullDiag = row.diag + (row.tname ? ` (${row.tname})` : '');
                if (!diagStats[fullDiag]) diagStats[fullDiag] = 0;
                diagStats[fullDiag]++;

                // ‡∏ô‡∏±‡∏ö‡πÅ‡∏ú‡∏ô‡∏Å
                if (!deptStats[row.dept]) deptStats[row.dept] = 0;
                deptStats[row.dept]++;

                // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏£‡∏≤‡∏á
                const tableKey = fullDiag + "|" + row.drug;
                if(!tableMap[tableKey]) tableMap[tableKey] = { diag: fullDiag, drug: row.drug, dept: row.dept, cases: 0, qty: 0 };
                tableMap[tableKey].cases++;
                tableMap[tableKey].qty += row.qty;
            });

            // 2. ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏£‡∏≤‡∏ü‡πÄ‡∏ó‡∏£‡∏ô‡∏î‡πå 4 ‡∏õ‡∏µ (‡πÅ‡∏¢‡∏Å OPD/IPD ‡πÅ‡∏•‡∏∞‡πÄ‡∏°‡∏¥‡∏ô Slicer ‡∏õ‡∏µ)
            const trendStats = { 
                "66": { total: 0, opd: 0, ipd: 0 }, 
                "67": { total: 0, opd: 0, ipd: 0 }, 
                "68": { total: 0, opd: 0, ipd: 0 }, 
                "69": { total: 0, opd: 0, ipd: 0 } 
            };
            
            rawDataGlobal.filter(row => {
                // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏£‡∏≤‡∏ü‡πÄ‡∏ó‡∏£‡∏ô‡∏î‡πå ‡∏Å‡∏£‡∏≠‡∏á‡πÅ‡∏Ñ‡πà ‡∏¢‡∏≤ ‡πÅ‡∏•‡∏∞ ‡πÅ‡∏ú‡∏ô‡∏Å ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
                const matchD = (dFilter === "all" || row.drug === dFilter);
                const matchDep = (depFilter === "all" || row.dept === depFilter);
                return matchD && matchDep;
            }).forEach(row => {
                if(row.year !== "other") {
                    trendStats[row.year].total++;
                    if(row.type === "opd") trendStats[row.year].opd++;
                    else trendStats[row.year].ipd++;
                }
            });

            // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï KPI
            document.getElementById("kpiCases").innerText = totalCases.toLocaleString();
            document.getElementById("kpiQty").innerText = totalQty.toLocaleString(undefined, {minimumFractionDigits: 0, maximumFractionDigits: 2});
            document.getElementById("kpiOPD").innerText = opdCnt.toLocaleString();
            document.getElementById("kpiIPD").innerText = ipdCnt.toLocaleString();

            // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡πÇ‡∏î‡∏ô‡∏±‡∏ó‡∏ï‡∏≤‡∏° Slicer
            document.getElementById("titleDrugChart").innerText = dFilter === "all" ? "üç© ‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏¢‡∏≤ (‡∏ï‡∏≤‡∏°‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏Ñ‡∏™)" : `üç© ‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏ú‡∏ô‡∏Å‡∏ó‡∏µ‡πà‡∏à‡πà‡∏≤‡∏¢‡∏¢‡∏≤ ${dFilter}`;

            // ‡∏ß‡∏≤‡∏î‡∏Å‡∏£‡∏≤‡∏ü
            drawDrugDonut(dFilter === "all" ? drugStats : deptStats); 
            drawDiagBar(diagStats);
            drawDeptBar(deptStats);
            drawTrendLine(trendStats);

            // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡∏≤‡∏£‡∏≤‡∏á
            const sortedTable = Object.values(tableMap).sort((a,b) => b.cases - a.cases);
            let tbody = "";
            sortedTable.forEach((item, idx) => {
                tbody += `<tr>
                    <td>${idx + 1}</td>
                    <td>${item.diag}</td>
                    <td>${item.drug}</td>
                    <td style="text-align:center;">${item.dept}</td>
                    <td>${item.cases.toLocaleString()}</td>
                    <td style="font-weight:bold; color:#d32f2f;">${item.qty.toLocaleString(undefined, {maximumFractionDigits:2})}</td>
                </tr>`;
            });
            document.getElementById("dataTableBody").innerHTML = tbody;
        }

        function drawDrugDonut(statsObj) {
            const sorted = Object.keys(statsObj).map(k => ({name: k, val: statsObj[k]})).sort((a,b) => b.val - a.val);
            const top5 = sorted.slice(0, 5);
            const others = sorted.slice(5).reduce((sum, item) => sum + item.val, 0);
            
            let labels = top5.map(i => i.name.length > 20 ? i.name.substring(0,20)+'...' : i.name);
            let data = top5.map(i => i.val);
            if(others > 0) { labels.push("‡∏≠‡∏∑‡πà‡∏ô‡πÜ"); data.push(others); }

            if(charts.drugDonut) charts.drugDonut.destroy();
            charts.drugDonut = new Chart(document.getElementById('drugDonutChart').getContext('2d'), {
                type: 'doughnut',
                data: { labels: labels, datasets: [{ data: data, backgroundColor: ['#ef5350', '#ec407a', '#ab47bc', '#7e57c2', '#5c6bc0', '#bdbdbd'], borderWidth: 1 }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right', labels: { boxWidth: 12, font: {size: 11} } } } }
            });
        }

        function drawDiagBar(statsObj) {
            const top10 = Object.keys(statsObj).map(k => ({name: k, val: statsObj[k]})).sort((a,b) => b.val - a.val).slice(0, 10);
            if(charts.diagBar) charts.diagBar.destroy();
            charts.diagBar = new Chart(document.getElementById('diagBarChart').getContext('2d'), {
                type: 'bar',
                data: {
                    labels: top10.map(i => i.name.length > 25 ? i.name.substring(0,25)+'...' : i.name),
                    datasets: [{ label: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏Ñ‡∏™', data: top10.map(i => i.val), backgroundColor: '#1976d2', borderRadius: 3 }]
                },
                options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
            });
        }

        function drawDeptBar(statsObj) {
            const top5 = Object.keys(statsObj).map(k => ({name: k, val: statsObj[k]})).sort((a,b) => b.val - a.val).slice(0, 5);
            if(charts.deptBar) charts.deptBar.destroy();
            charts.deptBar = new Chart(document.getElementById('deptBarChart').getContext('2d'), {
                type: 'bar',
                data: {
                    labels: top5.map(i => i.name),
                    datasets: [{ label: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏Ñ‡∏™', data: top5.map(i => i.val), backgroundColor: '#00897b', borderRadius: 3 }]
                },
                options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
            });
        }

        function drawTrendLine(trendStats) {
            if(charts.trendLine) charts.trendLine.destroy();
            charts.trendLine = new Chart(document.getElementById('trendLineChart').getContext('2d'), {
                type: 'line',
                data: {
                    labels: ['‡∏õ‡∏µ 66', '‡∏õ‡∏µ 67', '‡∏õ‡∏µ 68', '‡∏õ‡∏µ 69(4‡∏î.)'],
                    datasets: [
                        {
                            label: '‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (Total)',
                            data: [trendStats["66"].total, trendStats["67"].total, trendStats["68"].total, trendStats["69"].total],
                            borderColor: '#1976d2', backgroundColor: '#1976d2', borderWidth: 3, pointRadius: 5, tension: 0.3
                        },
                        {
                            label: 'OPD (‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏ô‡∏≠‡∏Å)',
                            data: [trendStats["66"].opd, trendStats["67"].opd, trendStats["68"].opd, trendStats["69"].opd],
                            borderColor: '#388e3c', backgroundColor: '#388e3c', borderWidth: 2, pointRadius: 4, tension: 0.3, borderDash: [5, 5]
                        },
                        {
                            label: 'IPD (‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡πÉ‡∏ô)',
                            data: [trendStats["66"].ipd, trendStats["67"].ipd, trendStats["68"].ipd, trendStats["69"].ipd],
                            borderColor: '#f57c00', backgroundColor: '#f57c00', borderWidth: 2, pointRadius: 4, tension: 0.3, borderDash: [5, 5]
                        }
                    ]
                },
                options: { 
                    responsive: true, maintainAspectRatio: false, 
                    plugins: { legend: { position: 'bottom' } }, 
                    scales: { y: { beginAtZero: true } } 
                }
            });
        }
    </script>
</body>
</html>
